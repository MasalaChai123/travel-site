<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Regent Tour - Webmaster CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="css/styles.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        .editor-content {
            min-height: 600px;
            padding: 40px;
            background: white;
            color: #333;
            line-height: 1.8;
        }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex text-gray-800 font-sans">
    
    <!-- Sidebar -->
    <aside class="w-72 bg-slate-900 text-white flex flex-col flex-shrink-0 h-screen sticky top-0 shadow-xl z-20">
        <div class="p-6 text-xl font-bold text-center border-b border-gray-700 bg-slate-800">
            <span class="text-red-500 mr-1">R</span> Webmaster
        </div>
        
        <!-- Toolbar for Menu -->
        <div class="px-4 py-3 bg-slate-800 border-b border-gray-700 flex justify-between items-center">
            <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Site Structure</span>
            <button onclick="openPageModal()" class="text-xs bg-emerald-600 hover:bg-emerald-700 text-white px-2 py-1 rounded transition-colors">
                <i class="fa-solid fa-plus mr-1"></i> Add Page
            </button>
        </div>

        <nav class="flex-1 p-2 overflow-y-auto" id="sidebar-nav">
            <!-- Dynamic Menu Tree Injected Here -->
        </nav>

        <!-- System -->
        <div class="p-4 border-t border-gray-700 bg-slate-800">
            <a href="index.html" target="_blank" class="block w-full text-center px-4 py-2 text-emerald-400 hover:bg-slate-700 rounded text-sm font-bold border border-emerald-900">
                <i class="fa-solid fa-external-link-alt mr-2"></i> View Live Site
            </a>
            <div class="text-xs text-center text-gray-500 mt-2">v2.1 Dynamic CMS</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden">
        
        <!-- Top Bar -->
        <header class="bg-white border-b border-gray-200 h-16 flex items-center justify-between px-8 shadow-sm z-10">
            <div class="flex items-center gap-4">
                <div id="page-info-display" class="hidden">
                    <h1 class="text-xl font-bold text-gray-800" id="current-page-name">Page Name</h1>
                    <div class="text-xs text-gray-400 font-mono" id="current-file-name">filename.html</div>
                </div>
                <div id="welcome-msg" class="text-xl font-bold text-gray-400">Select a page to edit</div>
            </div>
            
            <div class="flex gap-3">
                 <button onclick="resetToDefault()" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded text-sm font-medium transition-colors">
                    Reset All
                </button>
                <button onclick="saveCurrentPage()" id="save-btn" class="px-6 py-2 bg-emerald-600 text-white rounded shadow hover:bg-emerald-700 transition-colors font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fa-solid fa-save"></i> Save Changes
                </button>
            </div>
        </header>

        <!-- Editor Container -->
        <div class="flex-1 overflow-y-auto bg-gray-100 p-8 flex justify-center">
            
            <div id="editor-wrapper" class="w-full max-w-5xl bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col h-full md:h-auto min-h-[80vh] opacity-50 pointer-events-none transition-opacity">
                
                <!-- Toolbar -->
                <div class="bg-gray-50 border-b border-gray-200 p-2 flex flex-wrap gap-2 sticky top-0 z-10 rounded-t-xl items-center">
                    
                    <!-- Font Style -->
                    <div class="flex bg-white rounded border border-gray-300 shadow-sm toolbar-group">
                        <select onchange="format('formatBlock', this.value); this.selectedIndex=0;" class="p-2 text-sm outline-none border-r border-gray-200 hover:bg-gray-50 cursor-pointer w-24">
                            <option value="">Type</option>
                            <option value="H1">Title 1</option>
                            <option value="H2">Title 2</option>
                            <option value="H3">Title 3</option>
                            <option value="P">Paragraph</option>
                        </select>
                        <select onchange="format('fontName', this.value); this.selectedIndex=0;" class="p-2 text-sm outline-none border-r border-gray-200 hover:bg-gray-50 cursor-pointer w-24">
                            <option value="">Font</option>
                            <option value="Arial">Arial</option>
                            <option value="'Noto Sans TC'">Noto Sans</option>
                            <option value="'Noto Serif TC'">Serif</option>
                            <option value="Verdana">Verdana</option>
                        </select>
                        <select onchange="format('fontSize', this.value); this.selectedIndex=0;" class="p-2 text-sm outline-none hover:bg-gray-50 cursor-pointer w-20">
                            <option value="">Size</option>
                            <option value="1">Small</option>
                            <option value="3">Normal</option>
                            <option value="5">Large</option>
                            <option value="7">Huge</option>
                        </select>
                    </div>

                    <!-- Decoration -->
                    <div class="flex bg-white rounded border border-gray-300 shadow-sm toolbar-group">
                        <button onclick="format('bold')" class="p-2 hover:bg-gray-100 w-8" title="Bold"><i class="fa-solid fa-bold"></i></button>
                        <button onclick="format('italic')" class="p-2 hover:bg-gray-100 w-8" title="Italic"><i class="fa-solid fa-italic"></i></button>
                        <button onclick="format('underline')" class="p-2 hover:bg-gray-100 w-8" title="Underline"><i class="fa-solid fa-underline"></i></button>
                        <input type="color" onchange="format('foreColor', this.value)" class="w-8 h-full p-0 border-0 cursor-pointer" title="Text Color" value="#000000">
                    </div>

                    <!-- Alignment -->
                    <div class="flex bg-white rounded border border-gray-300 shadow-sm toolbar-group">
                        <button onclick="format('justifyLeft')" class="p-2 hover:bg-gray-100 w-8"><i class="fa-solid fa-align-left"></i></button>
                        <button onclick="format('justifyCenter')" class="p-2 hover:bg-gray-100 w-8"><i class="fa-solid fa-align-center"></i></button>
                        <button onclick="format('justifyRight')" class="p-2 hover:bg-gray-100 w-8"><i class="fa-solid fa-align-right"></i></button>
                    </div>

                    <!-- Media -->
                    <div class="flex bg-white rounded border border-gray-300 shadow-sm ml-auto">
                        <label class="p-2 hover:bg-gray-100 cursor-pointer flex items-center gap-1 text-sm font-medium text-gray-600 border-r border-gray-200">
                            <i class="fa-regular fa-image"></i> Image
                            <input type="file" id="img-input" class="hidden" accept="image/*" onchange="insertImage(this)">
                        </label>
                         <button onclick="toggleSourceMode()" id="source-btn" class="p-2 hover:bg-gray-100 text-sm font-medium text-blue-600 flex items-center gap-1">
                            <i class="fa-solid fa-code"></i> Source
                        </button>
                    </div>
                </div>

                <!-- Visual Editor -->
                <div id="visual-editor" contenteditable="true" class="editor-content outline-none flex-1"></div>
                
                <!-- Source Code Editor -->
                <textarea id="source-editor" class="source-editor" spellcheck="false"></textarea>

            </div>
        </div>
    </main>

    <!-- Modal for Adding/Editing Page Info -->
    <div id="page-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6">
            <h3 class="text-xl font-bold mb-4" id="modal-title">Add New Page</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Page Name (Menu Title)</label>
                    <input type="text" id="modal-page-name" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g. About Us">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">HTML Filename</label>
                    <div class="flex items-center">
                         <input type="text" id="modal-file-name" class="mt-1 block w-full border border-gray-300 rounded-l px-3 py-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="e.g. about">
                         <span class="mt-1 px-3 py-2 bg-gray-100 border border-l-0 border-gray-300 rounded-r text-gray-500">.html</span>
                    </div>
                </div>
                <div>
                     <label class="block text-sm font-medium text-gray-700">Parent Menu</label>
                     <select id="modal-parent-id" class="mt-1 block w-full border border-gray-300 rounded px-3 py-2">
                         <option value="">(None - Top Level)</option>
                         <!-- Dynamic Options -->
                     </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="closePageModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="submitPageModal()" class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700">Save Page</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let siteData = {
            pages: [
                { id: 'home', name: 'Home Page', file: 'index.html', parent: null, isSystem: true },
                { id: 'fiji-intro', name: 'Fiji Introduction', file: 'fiji-intro.html', parent: null, isSystem: true },
                { id: 'fiji-guide', name: 'Fiji How-to-Play', file: 'fiji-guide.html', parent: null, isSystem: true },
                { id: 'fiji-itinerary', name: 'Recommended Itineraries', file: 'fiji-itinerary.html', parent: null, isSystem: true },
                { id: 'fiji-hotels', name: 'Selected Hotels', file: 'fiji-hotels.html', parent: null, isSystem: true },
                { id: 'palau-guide', name: 'Palau Guide', file: 'palau-guide.html', parent: null, isSystem: true }
            ]
        };

        let currentPageId = null;
        let isSourceMode = false;

        // --- Initialization ---
        window.onload = function() {
            const savedStructure = localStorage.getItem('site_structure');
            if (savedStructure) {
                siteData = JSON.parse(savedStructure);
            }
            renderSidebar();
        };

        // --- Sidebar Rendering ---
        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            nav.innerHTML = '';
            
            // 1. Render Root Items
            // Note: We iterate the full array to respect user-defined order
            const rootPages = siteData.pages.filter(p => !p.parent);
            rootPages.forEach(page => {
                nav.appendChild(createNavItem(page));
            });

            // Update Modal Parent Options
            const parentSelect = document.getElementById('modal-parent-id');
            parentSelect.innerHTML = '<option value="">(None - Top Level)</option>';
            siteData.pages.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                parentSelect.appendChild(opt);
            });
        }

        function createNavItem(page) {
            const container = document.createElement('div');
            
            // Item Row
            const div = document.createElement('div');
            div.className = `nav-item flex items-center justify-between px-3 py-2 rounded cursor-pointer mb-1 transition-colors ${currentPageId === page.id ? 'bg-slate-700 text-white' : 'text-gray-400 hover:bg-slate-800 hover:text-gray-200'}`;
            div.onclick = (e) => {
                // Prevent click if clicking actions
                if(e.target.closest('.actions')) return;
                loadPage(page.id);
            };

            const titleSpan = document.createElement('div');
            titleSpan.className = "flex items-center gap-2 overflow-hidden";
            titleSpan.innerHTML = `<i class="fa-regular fa-file-lines text-xs"></i> <span class="truncate text-sm font-medium">${page.name}</span>`;
            
            // Actions
            const actions = document.createElement('div');
            actions.className = 'actions';
            
            // Reorder Buttons
            const upBtn = document.createElement('button');
            upBtn.innerHTML = '<i class="fa-solid fa-chevron-up text-gray-400 hover:text-white text-xs"></i>';
            upBtn.className = "px-1";
            upBtn.title = "Move Up";
            upBtn.onclick = (e) => { e.stopPropagation(); movePage(page.id, -1); };
            actions.appendChild(upBtn);

            const downBtn = document.createElement('button');
            downBtn.innerHTML = '<i class="fa-solid fa-chevron-down text-gray-400 hover:text-white text-xs"></i>';
            downBtn.className = "px-1 mr-2";
            downBtn.title = "Move Down";
            downBtn.onclick = (e) => { e.stopPropagation(); movePage(page.id, 1); };
            actions.appendChild(downBtn);

            // Delete Button (Only for non-system pages)
            if (!page.isSystem) {
                 const delBtn = document.createElement('button');
                 delBtn.innerHTML = '<i class="fa-solid fa-trash text-red-500 hover:text-red-400"></i>';
                 delBtn.title = "Delete Page";
                 delBtn.onclick = (e) => { e.stopPropagation(); deletePage(page.id); };
                 actions.appendChild(delBtn);
            }

            div.appendChild(titleSpan);
            div.appendChild(actions);
            container.appendChild(div);

            // Submenu
            // We must respect the array order of siteData.pages even for children
            const children = siteData.pages.filter(p => p.parent === page.id);
            if (children.length > 0) {
                const subDiv = document.createElement('div');
                subDiv.className = "submenu";
                children.forEach(child => {
                    subDiv.appendChild(createNavItem(child));
                });
                container.appendChild(subDiv);
            }

            return container;
        }

        // --- Ordering Logic ---
        function movePage(id, direction) {
            const page = siteData.pages.find(p => p.id === id);
            if (!page) return;

            // Get all siblings in their current order in the main array
            // We use siteData.pages to ensure we are looking at the persistent order
            const siblings = siteData.pages.filter(p => p.parent === page.parent);
            const siblingIndex = siblings.findIndex(p => p.id === id);
            
            // Check bounds in sibling context
            if (direction === -1 && siblingIndex === 0) return; // Already top
            if (direction === 1 && siblingIndex === siblings.length - 1) return; // Already bottom

            // Identify the neighbor to swap with
            const neighbor = siblings[siblingIndex + direction];

            // Find real indices in the main storage array
            const idxA = siteData.pages.indexOf(page);
            const idxB = siteData.pages.indexOf(neighbor);

            // Perform Swap
            const temp = siteData.pages[idxA];
            siteData.pages[idxA] = siteData.pages[idxB];
            siteData.pages[idxB] = temp;

            // Save and Reload
            localStorage.setItem('site_structure', JSON.stringify(siteData));
            renderSidebar();
        }

        // --- Editor Logic ---
        function format(command, value) {
            document.execCommand(command, false, value);
            document.getElementById('visual-editor').focus();
        }

        function insertImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgTag = `<img src="${e.target.result}" style="max-width:100%; height:auto; border-radius: 8px; margin: 10px auto; display: block;" />`;
                    document.execCommand('insertHTML', false, imgTag);
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        function toggleSourceMode() {
            const visual = document.getElementById('visual-editor');
            const source = document.getElementById('source-editor');
            const btn = document.getElementById('source-btn');
            const toolbarGroups = document.querySelectorAll('.toolbar-group');

            if (isSourceMode) {
                // Switch to Visual
                visual.innerHTML = source.value;
                source.style.display = 'none';
                visual.style.display = 'block';
                btn.innerHTML = '<i class="fa-solid fa-code"></i> Source';
                btn.classList.remove('bg-blue-100', 'text-blue-700');
                btn.classList.add('text-blue-600');
                // Enable toolbar
                toolbarGroups.forEach(g => g.style.opacity = '1');
                toolbarGroups.forEach(g => g.style.pointerEvents = 'auto');
            } else {
                // Switch to Source
                source.value = visual.innerHTML;
                visual.style.display = 'none';
                source.style.display = 'block';
                btn.innerHTML = '<i class="fa-solid fa-eye"></i> Visual';
                btn.classList.add('bg-blue-100', 'text-blue-700');
                btn.classList.remove('text-blue-600');
                // Disable toolbar
                toolbarGroups.forEach(g => g.style.opacity = '0.5');
                toolbarGroups.forEach(g => g.style.pointerEvents = 'none');
            }
            isSourceMode = !isSourceMode;
        }

        // --- Loading & Saving ---
        async function loadPage(id) {
            if (isSourceMode) toggleSourceMode(); // Reset to visual

            currentPageId = id;
            const page = siteData.pages.find(p => p.id === id);
            
            // Update Header
            document.getElementById('page-info-display').classList.remove('hidden');
            document.getElementById('welcome-msg').classList.add('hidden');
            document.getElementById('current-page-name').innerText = page.name;
            document.getElementById('current-file-name').innerText = page.file;
            
            // Enable Editor
            document.getElementById('editor-wrapper').classList.remove('opacity-50', 'pointer-events-none');
            document.getElementById('save-btn').disabled = false;

            renderSidebar(); // Refresh active state

            // Load Content
            const savedContent = localStorage.getItem('page_content_' + id);
            if (savedContent) {
                document.getElementById('visual-editor').innerHTML = savedContent;
            } else {
                // Try fetching file content for system pages
                if (page.isSystem) {
                    try {
                        const response = await fetch(page.file);
                        const text = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(text, 'text/html');
                        const contentDiv = doc.getElementById('editable-content');
                        if (contentDiv) {
                            document.getElementById('visual-editor').innerHTML = contentDiv.innerHTML;
                        } else {
                            document.getElementById('visual-editor').innerHTML = '<p class="text-gray-400 italic">This page layout is hardcoded. Content editing is limited.</p>';
                        }
                    } catch (e) {
                        document.getElementById('visual-editor').innerHTML = '<p>New Page. Start typing...</p>';
                    }
                } else {
                    document.getElementById('visual-editor').innerHTML = '<p>New Page Content...</p>';
                }
            }
        }

        function saveCurrentPage() {
            if (!currentPageId) return;

            // Sync if in source mode
            if (isSourceMode) {
                const source = document.getElementById('source-editor');
                const visual = document.getElementById('visual-editor');
                visual.innerHTML = source.value;
            }

            const content = document.getElementById('visual-editor').innerHTML;
            localStorage.setItem('page_content_' + currentPageId, content);

            // Save Structure as well (simulating backend update)
            localStorage.setItem('site_structure', JSON.stringify(siteData));

            // Feedback
            const btn = document.getElementById('save-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
            btn.classList.add('bg-green-700');
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('bg-green-700');
            }, 2000);
        }

        function resetToDefault() {
            if(confirm("Reset entire CMS to default? All custom pages and edits will be lost.")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- Modal & Page Management ---
        function openPageModal() {
            document.getElementById('modal-page-name').value = '';
            document.getElementById('modal-file-name').value = '';
            document.getElementById('modal-parent-id').value = '';
            document.getElementById('page-modal').classList.remove('hidden');
        }

        function closePageModal() {
            document.getElementById('page-modal').classList.add('hidden');
        }

        function submitPageModal() {
            const name = document.getElementById('modal-page-name').value;
            const fileSlug = document.getElementById('modal-file-name').value;
            const parentId = document.getElementById('modal-parent-id').value;

            if (!name || !fileSlug) {
                alert("Please fill in all fields.");
                return;
            }

            const newId = 'page_' + Date.now();
            const newPage = {
                id: newId,
                name: name,
                file: fileSlug + '.html',
                parent: parentId || null,
                isSystem: false
            };

            siteData.pages.push(newPage);
            localStorage.setItem('site_structure', JSON.stringify(siteData));
            
            renderSidebar();
            closePageModal();
            loadPage(newId); // Auto select new page
        }

        function deletePage(id) {
            if(confirm("Delete this page? This cannot be undone.")) {
                // Delete the page
                siteData.pages = siteData.pages.filter(p => p.id !== id);
                // Also reset children parent to null (or delete them, but keeping them top level is safer)
                siteData.pages.forEach(p => {
                    if (p.parent === id) p.parent = null;
                });
                
                localStorage.setItem('site_structure', JSON.stringify(siteData));
                localStorage.removeItem('page_content_' + id);
                
                if (currentPageId === id) {
                    document.getElementById('visual-editor').innerHTML = '';
                    document.getElementById('editor-wrapper').classList.add('opacity-50', 'pointer-events-none');
                    document.getElementById('page-info-display').classList.add('hidden');
                    document.getElementById('welcome-msg').classList.remove('hidden');
                    currentPageId = null;
                }
                renderSidebar();
            }
        }
    </script>
  </body>
</html>